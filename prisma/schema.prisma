generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ---------- ENUMS ----------
enum OrderStatus {
  ORDER_PLACED
  PROCESSING
  SHIPPED
  DELIVERED
}

enum PaymentMethod {
  STRIPE
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum EscrowStatus {
  HELD
  RELEASED
  REFUNDED
}

enum RefundStatus {
  REQUESTED
  APPROVED
  REJECTED
  COMPLETED
}

enum StoreApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum GoalStatus {
  ACTIVE
  COMPLETED
  CANCELLED
  REFUNDED
  SAVED
}

enum DeliveryStatus {
  PENDING
  DISPATCHED
  IN_TRANSIT
  DELIVERED
}

enum NotificationChannel {
  IN_APP
  EMAIL
  // SMS removed
}

enum NotificationType {
  DEPOSIT_REMINDER
  GOAL_COMPLETE
  DELIVERY_UPDATE
  SYSTEM_ALERT
  PAYMENT_CONFIRMATION
}

// DepositFrequency enum removed

// ---------- MODELS ----------

model User {
  id    String @id
  name  String
  email String
  image String
  cart  Json   @default("{}")

  // Relations
  ratings           Rating[]
  addresses         Address[]
  store             Store?
  buyerOrders       Order[]            @relation("BuyerRelation")
  goals             Goal[]
  deposits          Deposit[]
  transactions      Transaction[]
  refundRequests    RefundRequest[]
  refunds           Refund[]           @relation("UserRefunds")
  storeApplications StoreApplication[]
  notifications     Notification[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Store {
  id          String   @id @default(cuid())
  userId      String   @unique
  name        String
  description String
  username    String   @unique
  address     String   // Existing address field
  
  // ✅ NEW FIELDS FOR DELIVERY MAP & SETTINGS
  city        String?
  zip         String?
  country     String?  @default("Pakistan")
  latitude    Float?   // For GPS Map
  longitude   Float?   // For GPS Map

  status      String   @default("pending")
  isActive    Boolean  @default(false)
  logo        String
  email       String
  contact     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations (Kept exactly as you had them)
  products         Product[]
  orders           Order[]
  user             User              @relation(fields: [userId], references: [id])
  storeApplication StoreApplication? @relation("Store_Application")
  priceLocks       PriceLock[]
  refunds          Refund[]

  @@index([status])
  @@index([isActive])
}

model Product {
  id          String   @id @default(cuid())
  name        String
  description String
  mrp         Float
  price       Float
  images      String[]
  category    String
  inStock     Boolean  @default(true)
  storeId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  store      Store       @relation(fields: [storeId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]
  ratings    Rating[]
  goals      Goal[]
  deposits   Deposit[]
  priceLocks PriceLock[]

  @@index([storeId])
  @@index([category])
  @@index([inStock])
}

model Order {
  id            String        @id @default(cuid())
  total         Float
  status        OrderStatus   @default(ORDER_PLACED)
  userId        String
  storeId       String
  addressId     String
  isPaid        Boolean       @default(false)
  paymentMethod PaymentMethod
  isCouponUsed  Boolean       @default(false)
  couponCode    String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  user           User            @relation("BuyerRelation", fields: [userId], references: [id])
  store          Store           @relation(fields: [storeId], references: [id])
  address        Address         @relation(fields: [addressId], references: [id])
  coupon         Coupon?         @relation(fields: [couponCode], references: [code])
  orderItems     OrderItem[]
  transactions   Transaction[]
  refundRequests RefundRequest[]
  escrows        Escrow[]
  priceLocks     PriceLock[]
  ratings        Rating[]

  @@index([userId])
  @@index([storeId])
  @@index([status])
  @@index([isPaid])
}

model OrderItem {
  orderId   String
  productId String
  quantity  Int
  price     Float

  // Relations
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@id([orderId, productId])
}

model Rating {
  id        String   @id @default(cuid())
  rating    Int
  review    String
  userId    String
  productId String
  orderId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@unique([userId, productId, orderId])
}

model Address {
  id        String   @id @default(cuid())
  userId    String
  name      String
  email     String
  street    String
  city      String
  state     String
  zip       String
  country   String
  phone     String
  
  latitude  Float?
  longitude Float?

  createdAt DateTime @default(now())

  // Relations
  orders Order[]
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Coupon {
  code        String   @id
  description String
  discount    Float
  forNewUser  Boolean
  forMember   Boolean  @default(false)
  isPublic    Boolean
  expiresAt   DateTime
  createdAt   DateTime @default(now())

  orders Order[]

  @@index([expiresAt])
}

model Goal {
  id           String     @id @default(cuid())
  userId       String
  productId    String?
  targetAmount Decimal    @db.Decimal(18, 2)
  saved        Decimal    @db.Decimal(18, 2) @default(0)
  status       GoalStatus @default(ACTIVE)
  startDate    DateTime?  @default(now())
  endDate      DateTime?
  
  // Frequency and nextDepositDate columns removed

  priceLocked  Boolean    @default(true)
  lockedPrice  Decimal    @db.Decimal(18, 2)

  // Relations
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  product       Product?        @relation(fields: [productId], references: [id])
  deposits      Deposit[]
  delivery      Delivery?
  notifications Notification[]
  refundRequest RefundRequest?  @relation("GoalRefundRequest")
  refund        Refund?         @relation("GoalRefund")
  transactions  Transaction[]
  escrow        Escrow?         @relation("GoalEscrow")
  priceLock     PriceLock?      @relation("GoalPriceLock")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([productId])
  @@index([status])
  @@index([endDate])
}

model Deposit {
  id              String   @id @default(cuid())
  goalId          String?
  productId       String?
  userId          String
  amount          Decimal  @db.Decimal(18, 2)
  depositDate     DateTime @default(now())
  paymentMethod   String
  status          String   @default("COMPLETED")
  receiptNumber   String   @unique
  stripePaymentId String?

  // Relations
  goal    Goal?    @relation(fields: [goalId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id])
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([goalId])
  @@index([userId])
  @@index([depositDate])
}

model Delivery {
  id              String         @id @default(cuid())
  goalId          String         @unique
  orderId         String?
  deliveryDate    DateTime?
  estimatedDate   DateTime?
  status          DeliveryStatus @default(PENDING)
  trackingNumber  String?
  carrier         String?
  
  // --- Customer Location (Static) ---
  shippingAddress String?
  coordinates     String?        // Legacy field (optional to keep)
  destinationLat  Float?         // Where the package is going
  destinationLng  Float?         // Where the package is going

  // --- ✅ NEW: Driver Location (Dynamic) ---
  latitude        Float?         // Driver's current Latitude
  longitude       Float?         // Driver's current Longitude
  location        String?        // e.g. "Driver En Route" or "Simulated Driver"

  // Relations
  goal              Goal             @relation(fields: [goalId], references: [id], onDelete: Cascade)
  notifications     Notification[]
  deliveryTrackings DeliveryTracking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([trackingNumber])
}

model Notification {
  id         String              @id @default(cuid())
  userId     String
  deliveryId String?
  goalId     String?
  type       NotificationType
  title      String
  message    String
  isRead     Boolean             @default(false)
  channel    NotificationChannel @default(IN_APP)

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  delivery Delivery? @relation(fields: [deliveryId], references: [id], onDelete: Cascade)
  goal     Goal?     @relation(fields: [goalId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

model Refund {
  id          String       @id @default(cuid())
  goalId      String       @unique
  userId      String
  storeId     String
  amount      Decimal      @db.Decimal(18, 2)
  reason      String
  status      RefundStatus @default(REQUESTED)
  adminNotes  String?
  processedAt DateTime?

  // Relations
  goal  Goal  @relation("GoalRefund", fields: [goalId], references: [id], onDelete: Cascade)
  user  User  @relation("UserRefunds", fields: [userId], references: [id], onDelete: Cascade)
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([storeId])
  @@index([status])
}

model StoreApplication {
  id            String                 @id @default(cuid())
  userId        String
  storeId       String?                @unique
  businessName  String
  documents     Json
  contactEmail  String
  contactPhone  String?
  address       String?
  taxId         String?
  cnic          String?
  accountNumber String?
  bankName      String?
  status        StoreApplicationStatus @default(PENDING)
  reviewedBy    String?
  reviewedAt    DateTime?
  reviewNotes   String?

  // Relations
  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  store Store? @relation("Store_Application", fields: [storeId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([taxId])
  @@index([cnic])
}

model PriceLock {
  id            String    @id @default(cuid())
  productId     String
  goalId        String?   @unique
  orderId       String?
  lockedPrice   Decimal   @db.Decimal(18, 2)
  originalPrice Decimal   @db.Decimal(18, 2)
  lockedBy      String?
  lockedAt      DateTime  @default(now())
  expiresAt     DateTime?
  status        String    @default("ACTIVE")
  storeId       String?

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  goal    Goal?   @relation("GoalPriceLock", fields: [goalId], references: [id])
  order   Order?  @relation(fields: [orderId], references: [id])
  store   Store?  @relation(fields: [storeId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@index([goalId])
  @@index([orderId])
  @@index([storeId])
  @@index([status])
  @@index([expiresAt])
}

model Escrow {
  id          String       @id @default(cuid())
  goalId      String?      @unique
  orderId     String?
  amount      Decimal      @db.Decimal(18, 2)
  
  platformFee Decimal      @db.Decimal(18, 2) @default(0) // Stores the 5% or 20% cut
  netAmount   Decimal      @db.Decimal(18, 2) @default(0) // Stores the actual amount sent to user/store
  
  currency    String       @default("PKR")
  status      EscrowStatus @default(HELD)
  heldSince   DateTime     @default(now())
  releasedAt  DateTime?
  releasedBy  String?
  notes       String?

  // Relations
  goal  Goal?  @relation("GoalEscrow", fields: [goalId], references: [id], onDelete: Cascade)
  order Order? @relation(fields: [orderId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([goalId])
  @@index([orderId])
  @@index([status])
}

model Transaction {
  id                String            @id @default(cuid())
  userId            String?
  orderId           String?
  goalId            String?
  amount            Decimal           @db.Decimal(18, 2)
  currency          String            @default("PKR")
  provider          String
  providerPaymentId String?
  status            TransactionStatus @default(PENDING)
  metadata          Json?

  // Relations
  user  User?  @relation(fields: [userId], references: [id], onDelete: Cascade)
  order Order? @relation(fields: [orderId], references: [id], onDelete: Cascade)
  goal  Goal?  @relation(fields: [goalId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([orderId])
  @@index([goalId])
  @@index([providerPaymentId])
  @@index([status])
}

model RefundRequest {
  id           String       @id @default(cuid())
  userId       String
  goalId       String?      @unique
  orderId      String?
  amount       Decimal      @db.Decimal(18, 2)
  reason       String
  status       RefundStatus @default(REQUESTED)
  adminId      String?
  processedAt  DateTime?
  responseNote String?

  // Relations
  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  goal  Goal?  @relation("GoalRefundRequest", fields: [goalId], references: [id])
  order Order? @relation(fields: [orderId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([goalId])
  @@index([orderId])
  @@index([status])
}

model DeliveryTracking {
  id         String   @id @default(cuid())
  deliveryId String
  latitude   Decimal  @db.Decimal(10, 7)
  longitude  Decimal  @db.Decimal(10, 7)
  location   String?
  status     String?
  recordedAt DateTime @default(now())

  // Relations
  delivery Delivery @relation(fields: [deliveryId], references: [id], onDelete: Cascade)

  @@index([deliveryId])
  @@index([recordedAt])
}